# LINEスタンプ自動生成ツール - 仕様書

## 概要

SlackをUIとして使い、Gemini APIとStable Diffusion WebUI APIを組み合わせてLINEスタンプを自動生成・管理するツール。

---

## 技術スタック

### バックエンド
- **言語**: Python 3.11+
- **Webフレームワーク**: FastAPI
- **非同期処理**: asyncio, threading
- **データベース**: SQLite + SQLAlchemy ORM
- **環境変数管理**: python-dotenv

### AI連携
- **テキスト生成**: Google Gemini API (gemini-1.5-flash)
- **画像生成**: AUTOMATIC1111 Stable Diffusion WebUI API
- **背景除去**: rembg
- **画像処理**: Pillow (PIL)

### Slack連携
- **フレームワーク**: Slack Bolt for Python
- **接続方式**: Socket Mode (ngrok不要)
- **UI**: Block Kit

### 画像処理
- **フォント**: Noto Sans JP / IPAexゴシック (日本語対応)
- **テキスト合成**: Pillow (白文字+黒縁取り)
- **画像形式**: 透過PNG
- **サイズ**: 370x320px (LINEスタンプ規定)

---

## ディレクトリ構成

```
line_stamp_tool/
├── main.py                  # エントリーポイント（Slack Bot + Web UI 同時起動）
├── .env                     # 環境変数設定
├── requirements.txt         # 依存パッケージ
├── fonts/                  # 日本語フォント格納
├── data/
│   └── stamps.db            # SQLite DB
├── output/                  # 生成済みスタンプの保存先
│   └── {set_id}/
│       ├── reference.png    # 参照画像（img2img用）
│       ├── stamp_01.png     # スタンプ画像（テキスト合成済み）
│       ├── sample_grid.png   # サンプル確認用グリッド
│       └── grid.png        # 完成確認用グリッド
├── lora_export/             # LoRA学習用データ
│   └── {set_id}/
│       ├── 001.png         # 画像
│       ├── 001.txt         # キャプション
│       └── ...
├── slack/                   # Slack Bot関連
│   ├── __init__.py
│   ├── bot.py               # Slack Bolt アプリ定義
│   ├── handlers.py          # イベントハンドラー
│   ├── blocks.py            # Block Kit UIパーツ
│   └── welcome_message.py   # ウェルカムメッセージ
├── core/                    # コア機能
│   ├── __init__.py
│   ├── gemini.py            # Gemini API連携
│   ├── sd_api.py            # SD WebUI API連携
│   ├── image_utils.py       # rembg・Pillow処理・テキスト合成
│   └── workflow.py          # メインワークフロー管理（ステートマシン）
├── db/                      # データベース関連
│   ├── __init__.py
│   ├── models.py            # SQLAlchemyモデル
│   └── crud.py              # DB操作
└── web/                     # Web UI関連
    ├── __init__.py
    ├── app.py               # FastAPI管理画面
    └── templates/
        └── index.html       # スタンプ一覧・詳細ページ
```

---

## データベーススキーマ

### StampSet テーブル
| カラム名 | 型 | 説明 | デフォルト |
|----------|-----|------|-----------|
| id | TEXT (UUID) | プライマリキー | auto |
| name | TEXT | セット名 | - |
| genre | TEXT | ジャンル | - |
| character_description | TEXT | Geminiが決めたキャラ設定テキスト | nullable |
| reference_image_path | TEXT | img2img用参照画像パス | nullable |
| status | TEXT | ステータス | 'direction_pending' |
| created_at | DATETIME | 作成日時 | now() |
| approved_at | DATETIME | 承認日時 | nullable |
| slack_ts | TEXT | Slackメッセージのts（更新用） | nullable |
| lora_exported | BOOLEAN | LoRA学習用データとして書き出し済みか | false |
| seed | INTEGER | 再現用seed値 | nullable |
| character_consistency | BOOLEAN | キャラクターの一貫性が必要か | true |

**ステータス一覧**:
`direction_pending` → `direction_approved` → `patterns_pending` → `patterns_approved` → `samples_generating` → `samples_review` → `full_generating` → `full_review` → `completed`

**ジャンル一覧**:
- `animal`: 動物キャラクター
- `original_character`: オリジナルキャラクター
- `concept`: コンセプト系（キャラなし・モノや抽象）
- `ai_free`: AIにおまかせ

### Stamp テーブル
| カラム名 | 型 | 説明 | デフォルト |
|----------|-----|------|-----------|
| id | TEXT (UUID) | プライマリキー | auto |
| set_id | TEXT | StampSet FK | - |
| number | INTEGER | スタンプ番号（1〜40） | - |
| phrase | TEXT | テキストフレーズ | - |
| prompt | TEXT | SD生成プロンプト | - |
| negative_prompt | TEXT | ネガティブプロンプト | nullable |
| image_path | TEXT | 透過PNG保存パス | nullable |
| status | TEXT | ステータス | 'pending' |
| seed | INTEGER | 再現用seed値 | nullable |
| is_sample | BOOLEAN | サンプル5枚かどうか | false |
| created_at | DATETIME | 作成日時 | now() |

---

## ワークフロー詳細

### STEP 0: トリガー
- Slackで `/stamp new` コマンド実行
- またはウェルカムメッセージのボタンクリック

### STEP 1: スタンプタイプ選択（新規追加）
Slack Block Kitで4つの選択肢を提示：
- 🐾 **動物キャラクター**: character_consistency=true
- 👤 **オリジナルキャラクター**: character_consistency=true  
- 🥦 **コンセプト系**: character_consistency=false
- 🎲 **AIにおまかせ**: character_consistency=true

### STEP 2: 元画像の確認
Botが「元画像はありますか？」とBlock Kitボタンで質問。
- **「画像あり」** → 画像アップロード待機 → `reference_image_path`に保存
- **「画像なし」** → STEP 3へ

### STEP 3: Geminiによる方向性決め
タイプ別のプロンプトでGeminiにキャラクター設定を生成。

**コンセプト系の場合の例示**:
```
コンセプト系の例：
- 野菜だけが喜怒哀楽を表現
- 白い謎の物体がひたすら何かを主張する
- 食べ物が日常会話する
- 幾何学図形が感情を持つ
- 天気現象がキャラクターのように振る舞う
```

**JSON出力形式**:
```json
[
  {
    "name": "キャラ名",
    "genre": "animal/original_character/concept/ai_free",
    "description": "キャラクター説明",
    "sd_base_prompt": "Stable Diffusion用プロンプト",
    "character_consistency": true/false
  }
]
```

### STEP 4: フレーズパターン生成（Gemini）
決定したキャラ設定を元に、30個のスタンプフレーズを生成。

### STEP 5: サンプル5枚生成
先頭5枚をSD WebUI APIで生成。

**生成パラメータ**:
- `width`: 370, `height`: 320
- `cfg_scale`: 7
- `steps`: 30
- `sampler_name`: "DPM++ 2M Karras"
- `seed`: character_consistency=trueの場合は固定、falseの場合はランダム
- `reference_image`: character_consistency=trueの場合のみ使用

**後処理**:
1. rembgで背景除去 → 透過PNG
2. Pillowでフレーズテキストを合成
   - フォント: Noto Sans JP または IPAexゴシック
   - 配置: 画像下部中央
   - 文字色: 白 + 黒縁取り
   - 文字サイズ: フレーズ長に応じて自動調整

### STEP 6: 全枚数生成
残りの25〜35枚を生成。character_consistencyロジックに従いseedを制御。

### STEP 7: 完了処理
- `output/{set_id}/` にスタンプ一式（透過PNG+テキスト）を保存
- `lora_export/{set_id}/` にLoRA学習用データを保存
- DBのstatusを `completed` に更新

---

## Slack UI設計

### コマンド
- `/stamp new` - 新しいスタンプセット作成
- `/stamp list` - スタンプセット一覧表示
- `/stamp help` - ヘルプ表示

### ボタンインターフェース
- ウェルカムメッセージにクイックスタートボタン
- 各ステップで承認・却下・修正提案ボタン
- モーダル入力による詳細修正

### Block Kitコンポーネント
- Section: テキスト表示
- Actions: ボタン群
- Image: 画像プレビュー
- Context: ヒント・補足情報
- Modal: テキスト入力フォーム

---

## Web管理画面

### エンドポイント
- `GET /` - スタンプセット一覧（フィルタ対応）
- `GET /set/{id}` - スタンプセット詳細
- `GET /set/{id}/export-lora` - LoRAデータエクスポート
- `GET /api/sets` - API: セット一覧（JSON）
- `GET /api/set/{id}` - API: セット詳細（JSON）

### 機能
- ステータス・ジャンル・日付でのフィルタリング
- グリッド表示によるスタンプ一覧
- LoRA学習用データのエクスポート
- リアルタイムの進捗確認

---

## 環境変数

```env
# Slack Configuration
SLACK_BOT_TOKEN=xoxb-...
SLACK_APP_TOKEN=xapp-...
SLACK_CHANNEL_ID=C...

# Google Gemini API
GEMINI_API_KEY=...

# Stable Diffusion WebUI
SD_WEBUI_URL=http://localhost:7860

# Database
DB_PATH=./data/stamps.db

# Output Directories
OUTPUT_DIR=./output
LORA_EXPORT_DIR=./lora_export

# Web UI
WEB_UI_PORT=8080

# Font for text composition
FONT_PATH=./fonts/NotoSansJP-Regular.ttf
```

---

## 依存パッケージ

```
slack-bolt              # Slack Botフレームワーク
slack-sdk              # Slack APIクライアント
google-generativeai    # Gemini API
requests               # HTTPクライアント
rembg                  # 背景除去
Pillow                 # 画像処理
sqlalchemy             # ORM
fastapi                # Webフレームワーク
uvicorn                # ASGIサーバー
jinja2                # テンプレートエンジン
python-dotenv          # 環境変数管理
aiofiles               # 非同期ファイル操作
uuid                   # UUID生成
datetime               # 日時処理
pathlib                # パス操作
threading              # スレッド処理
asyncio                # 非同期処理
```

---

## 起動方法

### 1. 前提条件
- Python 3.11+ インストール済み
- Stable Diffusion WebUIが `--api --nowebui` で起動済み
- Slackアプリの作成とトークン取得済み

### 2. セットアップ
```bash
# 依存パッケージインストール
pip install -r requirements.txt

# 環境変数設定
cp .env.example .env
# .envに必要なトークンを設定

# フォント配置
mkdir fonts
# fonts/に日本語フォントを配置
```

### 3. 起動
```bash
python main.py
```

### 4. アクセス
- Slack: 設定したチャンネルで `/stamp new`
- Web UI: http://localhost:8080

---

## Windows固有の注意事項

### rembgのインストール
```bash
pip install onnxruntime-gpu  # GPU版の場合
pip install rembg
```

### パス区切り文字
必ず `pathlib.Path` を使用すること。

### SD WebUI起動設定
```bat
set COMMANDLINE_ARGS=--api --nowebui --xformers
```

---

## 仕様変更履歴

### v1.1 (2026-02-18)
- ✅ スタンプタイプ選択機能を追加
- ✅ character_consistencyカラムを追加
- ✅ コンセプト系スタンプに対応
- ✅ フレーズテキストの自動合成機能を追加
- ✅ 日本語フォント対応
- ✅ キャラクター一貫性ロジックを実装

### v1.0 (2026-02-18)
- ✅ 基本ワークフロー実装
- ✅ Slack Bot連携
- ✅ Web管理画面
- ✅ データベース設計
- ✅ AI連携（Gemini + SD WebUI）
